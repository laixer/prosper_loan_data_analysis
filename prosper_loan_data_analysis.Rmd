---
title: "Analysis of Prosper loan data from Q4 2005 to Q1 2014"
output: html_document
---

Let's load the data and get an idea about its variables.

```{r}
library(lubridate)

loans <- read.csv("prosperLoanData.csv")
# Parse origination date.
loans$LoanOriginationDate <- ymd_hms(loans$LoanOriginationDate)
str(loans)
```

There are approximately 100K records with 81 variables. 

That's a lot of variables! Even with the variable definitions it's hard to keep
track of everything that's going on. Let's plot some data to start getting a 
handle on this data.


```{r}
library(plyr)
library(dplyr)
library(ggplot2)
library(tidyr)

# The origination quarter is in format "QX YYYY" which is hard to order so let's
# swap the order of the values.
loans.quarter_split <- separate(loans, 
         col = "LoanOriginationQuarter", 
         into = c("LoanOriginationQuarterOfYear", "LoanOriginationYear"))
loans$LoanOriginationQuarterSwapped = factor(paste(
  loans.quarter_split$LoanOriginationYear, 
  loans.quarter_split$LoanOriginationQuarterOfYear))

loans.originations_by_quarter <- loans %>%
  group_by(LoanOriginationQuarterSwapped) %>%
  summarize(NumLoansOriginated = n()) %>%
  arrange(LoanOriginationQuarterSwapped)

ggplot(loans.originations_by_quarter, 
       aes(LoanOriginationQuarterSwapped, NumLoansOriginated, group = "c")) +
  geom_point() + geom_line()
```

The earliest loans are from 2005-2006, when Prosper was founded and went public.
There's a drop after Q2 2008 (approaching nearly 0 in Q2 2009), likely because 
of the recession. 

The loans started picking up again after that and gradually
increased until the number of originated loans per quarter surpassed 5000, after 
which there was a drop in Q4 2012 and Q1 2013 after which loans started picking 
up again at an even greater rate. 

It would be interesting to see if we could later try to understand the drop and
the subsequent increased growth.

Grouping by month might reveal more details.

```{r}
library(scales)
loans$LoanOriginationMonth <- floor_date(loans$LoanOriginationDate, "month")

loans.originations_by_month <- loans %>%
  group_by(LoanOriginationMonth) %>%
  summarize(NumLoansOriginated = n()) %>%
  arrange(LoanOriginationMonth)

ggplot(loans.originations_by_month, 
       aes(LoanOriginationMonth, NumLoansOriginated, group = "c")) +
  geom_point() + 
  geom_line() +
  scale_x_datetime(labels = date_format("%b %Y"), 
                   breaks = date_breaks("3 months")) +
  theme(axis.text.x=element_text(angle=-90,vjust=0.5))
```

Grouped by months, the picture doesn't look much different than before. 
We can tell that the trough in 2013 happed in February. We also see a steep drop
off in March 2014 but it's possible that this data set is not complete for March
2014 as it's the last month in the data set.

What happens if we break down the loans by state? 
```{r}
loans.originations_by_month_state <- loans %>%
  group_by(LoanOriginationMonth, BorrowerState) %>%
  summarize(NumLoansOriginated = n()) %>%
  ungroup() %>%
  arrange(LoanOriginationMonth)

ggplot(loans.originations_by_month_state, 
       aes(LoanOriginationMonth, NumLoansOriginated, fill = BorrowerState)) +
  geom_bar(stat = "identity") + 
  scale_x_datetime(labels = date_format("%b %Y"), 
                   breaks = date_breaks("3 months")) +
  theme(axis.text.x=element_text(angle=-90,vjust=0.5))
```

As expected, this graph is a bit hard to read due to the number of states, but 
it appears that most of the loans are concentrated in a small number of states
so we can try looking at only some of the states. Before we do that, we can 
facet this data by state.

```{r}
ggplot(loans.originations_by_month_state, 
       aes(LoanOriginationMonth, NumLoansOriginated)) +
  facet_wrap(~BorrowerState) +
  geom_point() + 
  geom_line() +
  scale_x_datetime(labels = date_format("%b %Y"), 
                   breaks = date_breaks("3 months")) +
  theme(axis.text.x=element_text(angle=-90,vjust=0.5))
```

The trends in number of originated loans look similar, but we can see that in 
many states number of originated loans is pretty low. There's also a number of
loans with no state for earlier data.

Let's start looking at loan success rates. We first can break down the loans by 
status (grouped by origination date).

```{r}
loans.originations_by_month_status <- loans %>%
  group_by(LoanOriginationMonth, LoanStatus) %>%
  summarize(NumLoansOriginated = n()) %>%
  arrange(LoanOriginationMonth)

ggplot(loans.originations_by_month_status, 
       aes(LoanOriginationMonth, NumLoansOriginated, color = LoanStatus)) +
  geom_point() + 
  geom_line() +
  scale_x_datetime(labels = date_format("%b %Y"), 
                   breaks = date_breaks("3 months")) +
  theme(axis.text.x=element_text(angle=-90,vjust=0.5))
```

Since I'm interested in the difference between succesful and unsuccesful loans, 
I'm going to focus on comparing loans that were completed vs those that have 
been charged off.

```{r}
loans.originations_by_month_status <- loans %>%
  filter(LoanStatus %in% c("Completed", "Chargedoff")) %>%
  group_by(LoanOriginationMonth, LoanStatus) %>%
  summarize(NumLoansOriginated = n()) %>%
  arrange(LoanOriginationMonth)

ggplot(loans.originations_by_month_status, 
       aes(LoanOriginationMonth, NumLoansOriginated, color = LoanStatus)) +
  geom_point() + 
  geom_line() +
  scale_x_datetime(labels = date_format("%b %Y"), 
                   breaks = date_breaks("3 months")) +
  theme(axis.text.x=element_text(angle=-90,vjust=0.5))
```

Loans starting from July 2009 have a prosper "score" assigned to them which
indicates a probability of a loan "going bad" on a scale from 1-11 with 11 being
the best score. How do prosper scores break down between completed and charged
off loans?

```{r}
loans.completed <- loans %>%
  mutate(ProsperScore = as.factor(ProsperScore)) %>%
  filter(LoanStatus %in% c("Completed", "Chargedoff")) %>%
  filter(LoanOriginationMonth > "2009-07-01")

loans.completed_by_month_status_score <- loans.completed %>%
  group_by(LoanOriginationMonth, LoanStatus, ProsperScore) %>%
  summarize(NumLoansOriginated = n()) %>%
  arrange(LoanOriginationMonth)

ggplot(loans.completed_by_month_status_score, 
       aes(LoanOriginationMonth, NumLoansOriginated, fill = ProsperScore)) +
  facet_wrap(~ LoanStatus, ncol = 1) +
  geom_bar(stat = "identity") + 
  scale_x_datetime(labels = date_format("%b %Y"), 
                   breaks = date_breaks("3 months")) +
  theme(axis.text.x=element_text(angle=-90,vjust=0.5))
```

Let's normalize the counts to make the graph easier to interpret.

```{r}
loans.completed_by_month_status <- loans.completed %>%
  group_by(LoanOriginationMonth, LoanStatus) %>%
  summarize(NumLoansOriginatedTotal = n()) %>%
  arrange(LoanOriginationMonth)

loans.completed_by_month_status_score <- merge(
  loans.completed_by_month_status_score, 
  loans.completed_by_month_status, 
  by.x = c("LoanOriginationMonth", "LoanStatus"))

loans.completed_by_month_status_score <- mutate(
  loans.completed_by_month_status_score, 
  ProportionOriginated = NumLoansOriginated / NumLoansOriginatedTotal)

ggplot(loans.completed_by_month_status_score, 
       aes(LoanOriginationMonth, ProportionOriginated, fill = ProsperScore)) +
   facet_wrap(~ LoanStatus, ncol = 1) +
   geom_bar(stat = "identity") + 
   scale_x_datetime(labels = date_format("%b %Y"), 
                    breaks = date_breaks("3 months")) +
  theme(axis.text.x=element_text(angle=-90,vjust=0.5))
```

It's a bit surprising that the proportion of scores are similar between the two 
sets. Initially the scores skew high, but become more distributed over time 
presumably as the platform opens up (both with more variety of people coming to 
the platform and as more sophisticated/return hungry lenders enter)

```{r}
library(reshape2)
loan_features = .(Term, BorrowerAPR, BorrowerRate, LenderYield, 
                  EstimatedEffectiveYield, EstimatedLoss, EstimatedReturn, 
                  ListingCategory..numeric., BorrowerState, Occupation, 
                  EmploymentStatus, EmploymentStatusDuration, 
                  IsBorrowerHomeowner, CreditScoreRangeLower, 
                  CreditScoreRangeUpper, CurrentCreditLines, OpenCreditLines, 
                  TotalCreditLinespast7years, OpenRevolvingAccounts, 
                  OpenRevolvingMonthlyPayment, InquiriesLast6Months, 
                  TotalInquiries, CurrentDelinquencies, DelinquenciesLast7Years, 
                  RevolvingCreditBalance, BankcardUtilization, 
                  AvailableBankcardCredit, TradesNeverDelinquent..percentage., 
                  DebtToIncomeRatio, IncomeRange, IncomeVerifiable, 
                  StatedMonthlyIncome, ProsperPrincipalBorrowed, 
                  LoanOriginalAmount, MonthlyLoanPayment, Recommendations, 
                  Investors)

# proportion of loans completed vs charged off?

loans.completed = mutate(loans.completed, Term = as.factor(Term))
#completed_loans = nrow(filter(loans.completed, LoanStatus == "Completed"))
#chargedoff_loans = nrow(filter(loans.completed, LoanStatus == "Chargedoff"))

plot_categorical_breakdown <- function(feature) {
  x <- loans.completed %>%
    group_by_(feature) %>%
    summarize(TotalNumLoans = n())
  
  x2 <- loans.completed %>%
    group_by_(feature, "LoanStatus") %>%
    summarize(NumLoans = n())
  
  x3 <- merge(x, x2, by = c(feature))
  x3 <- mutate(x3, PropLoans = NumLoans / TotalNumLoans)
  
  return(ggplot(x3, aes_string(feature, "PropLoans", fill = "LoanStatus")) +
    geom_bar(stat = "identity"))
}

```

```{r}
plot_categorical_breakdown("Term")
plot_categorical_breakdown("ListingCategory..numeric.")
plot_categorical_breakdown("BorrowerState")
plot_categorical_breakdown("Occupation") + 
  theme(axis.text.x=element_text(angle=-90,hjust=0))
plot_categorical_breakdown("EmploymentStatus")
plot_categorical_breakdown("IsBorrowerHomeowner")
plot_categorical_breakdown("IncomeVerifiable")
```