---
title: "Analysis of Prosper loan data from Q4 2005 to Q1 2014"
output: html_document
---

Let's load the data and get an idea about its variables.

```{r}
library(lubridate)

loans <- read.csv("prosperLoanData.csv")
# Parse origination date.
loans$LoanOriginationDate <- ymd_hms(loans$LoanOriginationDate)
str(loans)
```

There are approximately 100K records with 81 variables. 

That's a lot of variables! Even with the variable definitions it's hard to keep
track of everything that's going on. Let's plot some data to start getting a 
handle on this data.


```{r}
library(dplyr)
library(ggplot2)
library(tidyr)

# The origination quarter is in format "QX YYYY" which is hard to order so let's
# swap the order of the values.
loans.quarter_split <- separate(loans, 
         col = "LoanOriginationQuarter", 
         into = c("LoanOriginationQuarterOfYear", "LoanOriginationYear"))
loans$LoanOriginationQuarterSwapped = factor(paste(
  loans.quarter_split$LoanOriginationYear, loans.quarter_split$LoanOriginationQuarterOfYear))

loans.originations_by_quarter <- loans %>%
  group_by(LoanOriginationQuarterSwapped) %>%
  summarize(NumLoansOriginated = n()) %>%
  arrange(LoanOriginationQuarterSwapped)

ggplot(loans.originations_by_quarter, aes(LoanOriginationQuarterSwapped, NumLoansOriginated, group = "c")) +
  geom_point() + geom_line()
```

The earliest loans are from 2005-2006, when Prosper was founded and went public.
There's a drop after Q2 2008 (approaching nearly 0 in Q2 2009), likely because 
of the recession. 

The loans started picking up again after that and gradually
increased until the number of originated loans per quarter surpassed 5000, after 
which there was a drop in Q4 2012 and Q1 2013 after which loans started picking 
up again at an even greater rate. 

It would be interesting to see if we could later try to understand the drop and
the subsequent increased growth.

Grouping by month might reveal more details.

```{r}
library(scales)
loans$LoanOriginationMonth <- floor_date(loans$LoanOriginationDate, "month")

loans.originations_by_month <- loans %>%
  group_by(LoanOriginationMonth) %>%
  summarize(NumLoansOriginated = n()) %>%
  arrange(LoanOriginationMonth)

ggplot(loans.originations_by_month, aes(LoanOriginationMonth, NumLoansOriginated, group = "c")) +
  geom_point() + 
  geom_line() +
  scale_x_datetime(labels = date_format("%b %Y"), breaks = date_breaks("3 months")) +
  theme(axis.text.x=element_text(angle=-90,vjust=0.5))
```

Grouped by months, the picture doesn't look much different than before. 
We can tell that the trough in 2013 happed in February. We also see a steep drop
off in March 2014 but it's possible that this data set is not complete for March
2014 as it's the last month in the data set.

What happens if we break down the loans by state? 
```{r}
loans.originations_by_month_state <- loans %>%
  group_by(LoanOriginationMonth, BorrowerState) %>%
  summarize(NumLoansOriginated = n()) %>%
  ungroup() %>%
  arrange(LoanOriginationMonth)

ggplot(loans.originations_by_month_state, aes(LoanOriginationMonth, 
                                        NumLoansOriginated, 
                                        fill = BorrowerState)) +
  geom_bar(stat = "identity") + 
  scale_x_datetime(labels = date_format("%b %Y"), breaks = date_breaks("3 months")) +
  theme(axis.text.x=element_text(angle=-90,vjust=0.5))
```

As expected, this graph is a bit hard to read due to the number of states, but 
it appears that most of the loans are concentrated in a small number of states
so we can try looking at only some of the states. Before we do that, we can 
facet this data by state.

```{r}
ggplot(loans.originations_by_month_state, aes(LoanOriginationMonth, 
                                              NumLoansOriginated)) +
  facet_wrap(~BorrowerState) +
  geom_point() + 
  geom_line() +
  scale_x_datetime(labels = date_format("%b %Y"), breaks = date_breaks("3 months")) +
  theme(axis.text.x=element_text(angle=-90,vjust=0.5))
```

The trends in number of originated loans look similar, but we can see that in 
many states number of originated loans is pretty low. There's also a number of
loans with no state for earlier data.



